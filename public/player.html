<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>İç Hastalıkları Değerlendirme Sistemi</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Seçilen şıkkın belirginleşmesi için özel stil */
        .selected-option { 
            border: 4px solid white !important; 
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .dimmed-option { opacity: 0.2; }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden font-sans flex flex-col">

    <div id="top-bar" class="hidden bg-slate-800 text-white p-2 flex justify-between items-center text-sm font-semibold">
        <span id="p-name-display" class="truncate max-w-[150px]"></span>
        <div class="bg-purple-600 rounded-full px-3 py-1">
            Kalan Süre: <span id="p-timer">10</span>s
        </div>
    </div>

    <div id="login-screen" class="flex-grow flex flex-col items-center justify-center p-6 space-y-4">
        <h1 class="text-3xl font-bold text-slate-800 text-center">Klinik Değerlendirme Oturumu</h1>
        <input type="text" id="nickname" placeholder="ADINIZI VE SOYADINIZI GİRİNİZ" class="w-full p-4 text-lg text-center border-2 border-slate-300 rounded-xl outline-none focus:border-purple-600 uppercase font-bold">
        <button onclick="joinGame()" class="w-full bg-purple-700 text-white py-4 rounded-xl text-xl font-bold shadow-md active:scale-95 transition">OTURUMA KATIL</button>
    </div>

    <div id="waiting-screen" class="hidden flex-grow flex flex-col items-center justify-center bg-slate-700 text-white p-6 text-center">
        <div class="animate-pulse">
            <h2 class="text-2xl font-bold mb-2 text-yellow-400">Veri İletimi Bekleniyor</h2>
            <p class="text-sm opacity-80">Oturum yöneticisinin onayı ile soru ekrana gelecektir.</p>
        </div>
    </div>

    <div id="stats-screen" class="hidden flex-grow flex flex-col bg-slate-900 text-white p-4 overflow-y-auto">
        <h2 id="result-status" class="text-3xl font-black text-center mb-4"></h2>
        <div class="bg-white/5 p-3 rounded-lg mb-4 border-l-4 border-blue-500">
            <p class="text-gray-400 text-xs uppercase tracking-wider">Tanımlanan Doğru Yanıt:</p>
            <p id="correct-ans-text" class="text-lg font-bold text-blue-300"></p>
        </div>
        <h3 class="text-center text-sm font-bold mb-4 text-gray-400">KATILIMCI YANIT DAĞILIMI</h3>
        <div id="mini-graph" class="space-y-2 mb-4"></div>
    </div>

    <div id="leaderboard-screen" class="hidden flex-grow flex flex-col bg-blue-950 text-white p-4">
        <h2 class="text-2xl font-black text-center text-yellow-500 mb-4">BAŞARI SIRALAMASI</h2>
        <div id="player-score-list" class="space-y-2"></div>
    </div>

    <div id="game-controller" class="hidden flex-grow flex flex-col p-2 bg-gray-100">
        <div class="bg-white p-3 rounded-xl shadow-sm mb-2 border border-slate-200">
            <h2 id="p-q-text" class="text-base font-bold text-center leading-snug text-slate-800"></h2>
        </div>
        
        <div class="grid grid-cols-1 gap-1.5 flex-grow">
            <button onclick="sendAns(0)" id="b-0" class="bg-red-500 text-white p-3 rounded-lg font-bold text-sm text-left shadow-sm active:scale-95 flex items-center h-[18%] transition-all">
                <span class="bg-black/20 px-2 py-0.5 rounded mr-3 text-xs">A</span> <span class="t truncate"></span>
            </button>
            <button onclick="sendAns(1)" id="b-1" class="bg-blue-500 text-white p-3 rounded-lg font-bold text-sm text-left shadow-sm active:scale-95 flex items-center h-[18%] transition-all">
                <span class="bg-black/20 px-2 py-0.5 rounded mr-3 text-xs">B</span> <span class="t truncate"></span>
            </button>
            <button onclick="sendAns(2)" id="b-2" class="bg-yellow-500 text-white p-3 rounded-lg font-bold text-sm text-left shadow-sm active:scale-95 flex items-center h-[18%] transition-all">
                <span class="bg-black/20 px-2 py-0.5 rounded mr-3 text-xs">C</span> <span class="t truncate"></span>
            </button>
            <button onclick="sendAns(3)" id="b-3" class="bg-green-600 text-white p-3 rounded-lg font-bold text-sm text-left shadow-sm active:scale-95 flex items-center h-[18%] transition-all">
                <span class="bg-black/20 px-2 py-0.5 rounded mr-3 text-xs">D</span> <span class="t truncate"></span>
            </button>
        </div>
    </div>

    <script>
        const socket = io();
        let myName = "";

        function joinGame() {
            myName = document.getElementById('nickname').value.trim();
            if(!myName) return;
            socket.emit('player-join', myName);
            document.getElementById('p-name-display').innerText = myName;
        }

        socket.on('join-success', () => {
            toggle('waiting-screen');
            document.getElementById('top-bar').classList.remove('hidden');
        });

        socket.on('new-question', (data) => {
            toggle('game-controller');
            document.getElementById('p-q-text').innerText = data.text;
            document.getElementById('p-timer').innerText = data.time;
            
            for(let i=0; i<4; i++) {
                const btn = document.getElementById(`b-${i}`);
                btn.classList.remove('selected-option', 'dimmed-option', 'opacity-40');
                btn.querySelector('.t').innerText = data.options[i];
                btn.disabled = false;
            }
        });

        socket.on('timer-tick', (t) => document.getElementById('p-timer').innerText = t);

        function sendAns(idx) {
            socket.emit('submit-answer', idx);
            
            // Görsel Geri Bildirim: Seçilen şıkkı vurgula, diğerlerini soluklaştır
            for(let i=0; i<4; i++) {
                const btn = document.getElementById(`b-${i}`);
                btn.disabled = true;
                if(i === idx) {
                    btn.classList.add('selected-option');
                } else {
                    btn.classList.add('dimmed-option');
                }
            }
        }

        socket.on('question-result-data', (data) => {
            toggle('stats-screen');
            const myAns = data.playersAnswers[socket.id];
            const status = document.getElementById('result-status');
            
            if(myAns === data.correctIndex) {
                status.innerText = "DOĞRU YANIT ✅";
                status.className = "text-3xl font-black text-center mb-4 text-green-500";
            } else {
                status.innerText = "HATALI YANIT ❌";
                status.className = "text-3xl font-black text-center mb-4 text-red-500";
            }

            document.getElementById('correct-ans-text').innerText = data.correctText;
            
            const graph = document.getElementById('mini-graph');
            graph.innerHTML = '';
            const labels = ['A','B','C','D'];
            const colors = ['bg-red-500','bg-blue-500','bg-yellow-500','bg-green-600'];
            const maxVal = Math.max(...data.stats) || 1;

            data.stats.forEach((count, i) => {
                const width = (count / maxVal) * 100;
                graph.innerHTML += `
                    <div class="flex items-center gap-2">
                        <div class="w-5 font-bold text-[10px]">${labels[i]}</div>
                        <div class="flex-grow h-4 bg-slate-800 rounded-full overflow-hidden">
                            <div class="${colors[i]} h-full transition-all duration-1000" style="width: ${width}%"></div>
                        </div>
                        <div class="w-5 text-right text-[10px]">${count}</div>
                    </div>
                `;
            });
        });

        socket.on('show-leaderboard', (sortedPlayers) => {
            toggle('leaderboard-screen');
            const list = document.getElementById('player-score-list');
            list.innerHTML = sortedPlayers.map((p, i) => `
                <div class="flex justify-between items-center ${p.nickname === myName ? 'bg-yellow-600/40 border border-yellow-500' : 'bg-slate-800'} p-3 rounded-lg shadow-sm">
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-yellow-500 text-sm">#${i+1}</span>
                        <span class="font-semibold text-xs truncate max-w-[120px]">${p.nickname}</span>
                    </div>
                    <span class="font-bold text-green-400 text-xs">${Math.floor(p.score)} Puan</span>
                </div>
            `).join('');
        });

        socket.on('game-over', () => {
            toggle('waiting-screen');
            document.querySelector('#waiting-screen h2').innerText = "OTURUM SONLANDI";
            document.querySelector('#waiting-screen p').innerText = "Başarı sıralaması ana ekrana yansıtılmıştır.";
        });

        function toggle(id) {
            ['login-screen', 'waiting-screen', 'game-controller', 'stats-screen', 'leaderboard-screen'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }
    </script>
</body>
</html>